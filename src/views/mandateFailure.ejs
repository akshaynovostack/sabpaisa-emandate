<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T4F3SZLP');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' *; media-src 'self' ; frame-src 'self'; form-action 'self' https://stage-securepay.sabpaisa.in https://securepay.sabpaisa.in;"/>
    <title>e-Mandate Registration Failed</title>
    <style>
        /* ===== DESIGN TOKENS ===== */
        :root {
          /* Palette – neutrals */
          --white: #ffffff;
          --gray-050: #f8f9fa;
          --gray-100: #f5f8fc;
          --gray-200: #e9ecef;
          --gray-900: #172b4d;

          /* Palette – Finloom brand blues */
          --blue-500: #006ced;
          --blue-700: #002e8b;

          /* Palette – semantic */
          --success-500: #22bb66;
          --success-050: #e6f7ef;
          --error-500: #dc3545;
          --error-050: #ffeded;
          --warning-500: #ffc107;
          --warning-050: #fff8e1;

          /* Shadows & radii */
          --radius-sm: 4px;
          --radius-md: 10px;
          --radius-lg: 16px;
          --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
          --shadow-md: 0 4px 16px rgba(0,46,139,.10);
          --shadow-lg: 0 8px 24px rgba(0,46,139,.15);

          /* Typography */
          --font-base: 'Inter', 'Segoe UI', Arial, sans-serif;
          --fs-base: 16px;
        }

        /* ===== FAILURE THEME ===== */
        body {
          --brand-bg: var(--gray-050);
          --brand-primary: var(--error-500);
          --brand-primary-dark: var(--error-500);
          --hero-accent: var(--error-500);
          
          font: var(--fs-base)/1.5 var(--font-base);
          background: var(--brand-bg);
          color: var(--gray-900);
          margin: 0;
          padding: 20px;
        }

        /* ===== ENHANCED ANIMATIONS ===== */
        .hero-section {
          animation: slideUpFade 0.8s ease-out;
        }

        /* ===== FINLOOM UI COMPONENTS ===== */
        .hero-icon {
          width: 80px; height: 80px;
          border-radius: 50%;
          background: var(--hero-accent);
          color: var(--white);
          display: flex; justify-content: center; align-items: center;
          font-size: 36px;
          font-weight: bold;
          box-shadow: 0 12px 24px rgba(220, 53, 69, 0.25);
          animation: iconShakeIn 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55),
                     iconPulseError 2s infinite ease-in-out;
          margin: 0 auto 20px;
          position: relative;
          transition: transform 0.3s ease;
        }

        .hero-icon::before {
          content: '';
          position: absolute;
          width: 100%;
          height: 100%;
          border-radius: 50%;
          background: var(--hero-accent);
          opacity: 0.3;
          animation: rippleError 2s infinite;
        }

        .hero-icon:hover {
          transform: scale(1.05);
        }

        h1.hero-heading {
          font-size: 30px; font-weight: 700;
          color: var(--brand-primary-dark);
          margin: 12px 0 4px;
          animation: slideUpFade 0.6s ease-out 0.2s both;
        }

        p.hero-message { 
          font-size: 16px; 
          margin-bottom: 18px; 
          color: var(--gray-900);
          animation: slideUpFade 0.6s ease-out 0.3s both;
        }

        .tx-pill {
          display: inline-flex; align-items: center; gap: 8px;
          padding: 8px 16px; border-radius: 24px;
          background: var(--white);
          box-shadow: var(--shadow-md);
          transition: .3s;
          font-weight: 600; font-size: 14px;
          margin-bottom: 20px;
          animation: slideUpFade 0.6s ease-out 0.4s both;
        }

        .tx-pill button {
          background: none; border: none; cursor: pointer;
          color: var(--brand-primary); font-size: 14px;
        }

        .tx-pill:hover { 
          box-shadow: var(--shadow-lg); 
          transform: translateY(-2px); 
        }

        .status-badge {
          display: inline-flex; align-items: center; gap: 6px;
          background: var(--error-500);
          color: var(--white);
          padding: 8px 14px;
          border-radius: 24px;
          font-size: 12px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 15px;
          animation: slideUpFade 0.6s ease-out 0.5s both;
          box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        .card {
          background: var(--white); 
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-md); 
          overflow: hidden;
          padding: 28px; 
          margin: 20px 0; 
          position: relative;
          transition: .3s;
          animation: slideUpFade 0.6s ease-out 0.6s both;
        }

        .card:hover { 
          box-shadow: var(--shadow-lg); 
          transform: translateY(-3px); 
        }

        .card.error-card {
          border-left: 4px solid var(--error-500);
        }

        .btn-warning {
          width: 100%; padding: 16px; border: none;
          border-radius: var(--radius-md); font-weight: 600; cursor: pointer;
          position: relative; overflow: hidden; transition: .3s;
          display: flex; align-items: center; justify-content: center; gap: 8px;
          background: var(--warning-500); 
          color: var(--gray-900);
          text-decoration: none;
          font-size: 16px;
        }

        .btn-warning:hover { background: #e0a800; }
        .btn-warning:active { transform: translateY(1px); }

        .btn-secondary {
          width: 100%; padding: 12px; border: 1px solid var(--gray-200);
          border-radius: var(--radius-md); font-weight: 500; cursor: pointer;
          background: var(--white); color: var(--brand-primary);
          text-decoration: none; transition: .3s;
          display: flex; align-items: center; justify-content: center; gap: 8px;
          font-size: 14px;
        }

        .btn-secondary:hover { 
          background: var(--gray-050); 
          border-color: var(--brand-primary);
        }

        .toast {
          position: fixed; bottom: 30px; right: 30px;
          background: var(--brand-primary-dark); color: var(--white);
          padding: 14px 18px; border-radius: var(--radius-md);
          box-shadow: var(--shadow-lg); opacity: 0; pointer-events: none;
          transition: opacity .4s, transform .4s;
          transform: translateY(20px);
        }

        .toast.show { 
          opacity: 1; 
          transform: translateY(0); 
          pointer-events: auto; 
        }

        /* ===== CUSTOM FAILURE COMPONENTS ===== */
        .container {
          max-width: 600px;
          margin: 0 auto;
          text-align: center;
        }

        .details-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          text-align: left;
          margin: 20px 0;
        }

        .detail-item {
          padding: 16px;
          background: var(--gray-050);
          border-radius: var(--radius-md);
          border-left: 3px solid var(--error-500);
        }

        .detail-label {
          font-size: 12px;
          color: var(--gray-900);
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 6px;
          opacity: 0.7;
        }

        .detail-value {
          font-size: 14px;
          color: var(--gray-900);
          font-weight: 600;
          word-break: break-all;
        }

        .error-highlight {
          color: var(--error-500);
          font-weight: 700;
          font-size: 16px;
        }

        .info-card {
          background: var(--error-050);
          border: 1px solid var(--error-500);
          border-radius: var(--radius-md);
          padding: 20px;
          margin: 20px 0;
          display: flex;
          align-items: flex-start;
          gap: 12px;
          text-align: left;
          animation: slideUpFade 0.6s ease-out 0.7s both;
        }

        .info-icon {
          color: var(--error-500);
          font-size: 20px;
          margin-top: 2px;
        }

        .info-content h3 {
          color: var(--brand-primary-dark);
          font-size: 16px;
          font-weight: 600;
          margin: 0 0 8px 0;
        }

        .info-content p {
          color: var(--gray-900);
          font-size: 14px;
          line-height: 1.5;
          margin: 0;
        }

        .back-home {
          position: absolute;
          top: 20px;
          right: 20px;
          background: var(--white);
          border: 1px solid var(--gray-200);
          color: var(--gray-900);
          padding: 8px 16px;
          border-radius: var(--radius-sm);
          text-decoration: none;
          font-size: 12px;
          font-weight: 500;
          transition: .3s;
        }

        .back-home:hover {
          background: var(--gray-050);
          border-color: var(--brand-primary);
        }

        .footer-security {
          background: var(--gray-050);
          padding: 12px 20px;
          text-align: center;
          color: var(--gray-900);
          font-size: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          border-radius: var(--radius-md);
          margin-top: 20px;
          opacity: 0.8;
          animation: slideUpFade 0.6s ease-out 0.8s both;
        }

        .security-icon {
          color: var(--success-500);
        }

        /* ===== ENHANCED KEYFRAMES ===== */
        @keyframes iconShakeIn {
          0% {
            opacity: 0;
            transform: scale(0.2) rotate(45deg);
          }
          25% {
            opacity: 1;
            transform: scale(1.1) rotate(-15deg);
          }
          50% {
            transform: scale(0.95) rotate(5deg);
          }
          75% {
            transform: scale(1.05) rotate(-2deg);
          }
          100% {
            opacity: 1;
            transform: scale(1) rotate(0deg);
          }
        }

        @keyframes iconPulseError {
          0%, 100% {
            box-shadow: 0 12px 24px rgba(220, 53, 69, 0.25), 0 0 0 0 rgba(220, 53, 69, 0.3);
          }
          50% {
            box-shadow: 0 12px 24px rgba(220, 53, 69, 0.4), 0 0 0 10px rgba(220, 53, 69, 0);
          }
        }

        @keyframes rippleError {
          0% {
            transform: scale(1);
            opacity: 0.3;
          }
          100% {
            transform: scale(1.5);
            opacity: 0;
          }
        }

        @keyframes slideUpFade {
          0% {
            opacity: 0;
            transform: translateY(40px);
          }
          100% {
            opacity: 1;
            transform: translateY(0);
          }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
          .details-grid {
            grid-template-columns: 1fr;
            gap: 15px;
          }
          
          .container {
            margin: 10px;
          }
          
          .back-home {
            position: static;
            display: inline-block;
            margin-bottom: 20px;
          }
          
          body {
            padding: 10px;
          }
        }
    </style>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T4F3SZLP"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <a href="#" class="back-home">Back to Home</a>
    
    <main class="container">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-icon">✕</div>
            <h1 class="hero-heading">Mandate Setup Failed</h1>
            <p class="hero-message">We couldn't complete the e-Mandate registration. But don't worry – your down payment is safe and will be refunded shortly.</p>
            
            <!-- Transaction ID Pill -->
            <span class="tx-pill">
                <span style="color: var(--gray-900); opacity: 0.7; font-size: 12px;">Transaction ID:</span>
                <span id="transactionId" style="font-family: monospace; color: var(--brand-primary);"><%= mandateDetails.sabpaisaTxnId %></span>
                <button data-copy data-value="<%= mandateDetails.sabpaisaTxnId %>" onclick="copyToClipboard('<%= mandateDetails.sabpaisaTxnId %>')" style="color: var(--brand-primary);">
                    📋
                </button>
            </span>
        </div>

        <!-- Status Badge -->
        <div class="status-badge">
            ✕ Mandate Failed
        </div>

        <!-- Transaction Summary Card -->
        <section class="card error-card">
            <h2 style="color: var(--brand-primary-dark); margin: 0 0 20px 0; font-size: 20px;">Transaction Summary</h2>
            
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label">Payer Name</div>
                    <div class="detail-value"><%= mandateDetails.customer_name || 'N/A' %></div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value"><%= mandateDetails.customer_email_id || 'N/A' %></div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Amount Paid</div>
                    <div class="detail-value error-highlight">₹<%= mandateDetails.max_amount || '0.00' %></div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Status</div>
                    <div class="detail-value error-highlight"><%= mandateDetails.registration_status || 'Mandate Setup Failed' %></div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Error Code</div>
                    <div class="detail-value"><%= mandateDetails.responseCode || 'N/A' %></div>
                </div>
                
                <div class="detail-item">
                    <div class="detail-label">Error Message</div>
                    <div class="detail-value"><%= mandateDetails.responseMessage || mandateDetails.bank_status_message || 'An unexpected error occurred' %></div>
                </div>
            </div>
        </section>

        <!-- Retry Section -->
        <div class="info-card">
            <div class="info-icon">🔄</div>
            <div class="info-content">
                <h3>Want to Try Again?</h3>
                <p>You can retry the mandate setup process or contact our support team for assistance.</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; flex-direction: column; gap: 12px; margin: 20px 0;">
            <a href="#" class="btn-warning">
                🔄 Retry Mandate Setup
            </a>
            
            <a href="#" class="btn-secondary">
                💬 Need help? Contact Support
            </a>
        </div>

        <!-- Download Section -->
        <a href="#" class="btn-secondary" style="margin-top: 10px;">
            ⬇️ Download Transaction Receipt
        </a>

        <!-- Security Footer -->
        <div class="footer-security">
            <span class="security-icon">🔒</span>
            Secured by e-Nach
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Transaction ID copied to clipboard!</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize copy functionality
            initCopyFunctionality();
            
            // Start the countdown timer for auto-redirect
            startCountdown();
            
            // Add entry animations with staggered timing
            animateElements();
        });

        // Initialize copy functionality
        function initCopyFunctionality() {
            const copyBtn = document.querySelector('.tx-pill button');
            const transactionId = document.getElementById('transactionId');
            
            if (copyBtn && transactionId) {
                copyBtn.addEventListener('click', function() {
                    const textToCopy = transactionId.textContent;
                    
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        // Change button icon and color temporarily
                        const originalContent = this.innerHTML;
                        this.innerHTML = '✓';
                        this.style.color = 'var(--success-500)';
                        
                        // Show notification
                        showToast('Transaction ID copied to clipboard!');
                        
                        // Revert button after 1.5 seconds
                        setTimeout(() => {
                            this.innerHTML = originalContent;
                            this.style.color = '';
                        }, 1500);
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                        showToast('Failed to copy. Please try again.', true);
                    });
                });
            }
        }
        
        // Countdown timer function
        function startCountdown() {
            let seconds = 10; // Starting seconds
            
            const interval = setInterval(() => {
                seconds--;
                
                if (seconds <= 0) {
                    clearInterval(interval);
                    // Submit form with eNACH response
                    submitEnachResponse();
                    return;
                }
                
                // Add pulse animation when time is running low
                if (seconds <= 5) {
                    // You can add visual indicators here if needed
                }
            }, 1000);
        }

        // Submit eNACH response form
        function submitEnachResponse() {
            const redirectUrl = "<%= redirectUrl %>"; 
            const enachResponse = "<%= enachResponse %>"; 
            
            const form = document.createElement("form");
            form.method = "POST";
            form.action = redirectUrl;

            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "enachResponse";
            input.value = enachResponse;
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }

        // Animate elements with staggered timing
        function animateElements() {
            const elements = [
                '.hero-icon',
                '.hero-heading',
                '.hero-message',
                '.tx-pill',
                '.status-badge',
                '.error-card',
                '.info-card',
                '.footer-security'
            ];
            
            elements.forEach((selector, index) => {
                const element = document.querySelector(selector);
                if (element) {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(25px)';
                    
                    setTimeout(() => {
                        element.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    }, 100 + (index * 120));
                }
            });
        }

        // Copy to clipboard functionality
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Transaction ID copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy. Please try again.', true);
            });
        }

        // Show toast notification
        function showToast(message = 'Transaction ID copied to clipboard!', isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            if (isError) {
                toast.style.borderLeftColor = 'var(--warning-500)';
            }
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Add button interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Retry button functionality
            const retryBtn = document.querySelector('.btn-warning');
            if (retryBtn) {
                retryBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Add loading state
                    this.innerHTML = '⏳ Processing...';
                    this.style.opacity = '0.7';
                    this.style.pointerEvents = 'none';
                    
                    setTimeout(() => {
                        // Simulate redirect to mandate setup
                        window.location.href = '/mandate-setup';
                    }, 1500);
                });
            }

            // Support button functionality
            const supportBtn = document.querySelector('.btn-secondary[href="#"]:not([style*="margin-top"])');
            if (supportBtn) {
                supportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showToast('Redirecting to support...');
                    setTimeout(() => {
                        window.location.href = '/support';
                    }, 1000);
                });
            }

            // Download receipt functionality
            const downloadBtn = document.querySelector('.btn-secondary[style*="margin-top"]');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showToast('Receipt download started');
                });
            }
        });
    </script>
  </body>
</html>